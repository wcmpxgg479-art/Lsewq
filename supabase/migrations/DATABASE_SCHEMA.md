# Описание работы приложения "MotorFlow"

## 1. Введение и основная концепция

**MotorFlow** — это веб-приложение для управленческого учета в мастерской по ремонту электродвигателей. Его основная задача — отслеживать полный жизненный цикл ремонта: от момента приемки двигателя до выставления финального счета (УПД).

Ключевой принцип архитектуры — **разделение сущностей**. Каждая логическая единица (приемка, двигатель, отдельная работа, счет) хранится в своей таблице, что обеспечивает гибкость и масштабируемость. Центральным механизмом, связывающим выполненные работы со счетами, является поле `upd_document_id` в таблице с позициями работ.

---

## 2. Модель данных: Структура таблиц в Supabase

Система опирается на 4 основные таблицы, которые моделируют бизнес-процесс, и справочники.

### 2.1. Основные таблицы

*   #### `receptions` (Приемки)
    *   **Назначение:** Хранит информацию об одном акте приемки. Это "папка" верхнего уровня, которая группирует двигатели, поступившие за один раз от одного контрагента.
    *   **Ключевые поля:** `id`, `reception_number`, `reception_date`, `counterparty_id`.

*   #### `accepted_motors` (Принятые двигатели)
    *   **Назначение:** Хранит запись о каждом **уникальном физическом двигателе**, принятом в ремонт. Это "карточка" конкретного объекта.
    *   **Ключевые поля:** `id`, `reception_id` (связь с приемкой), `motor_service_description` (общее описание).
    *   **Особая роль:** Поле `id` этой таблицы является **источником данных для QR-кода**. Именно этот уникальный идентификатор зашивается в QR-код для отслеживания.

*   #### `reception_items` (Позиции работ)
    *   **Назначение:** Самая важная и детальная таблица. Хранит каждую отдельную работу или материал ("Замена подшипника", "Расход провода") для конкретного двигателя. Это "список задач" (to-do list) для ремонта.
    *   **Ключевые поля:** `id`, `accepted_motor_id` (связь с двигателем), `item_description`.
    *   **Центральный механизм:** Поле `upd_document_id`.
        *   Если `NULL`: Работа еще не включена ни в один счет. Она "свободна" и доступна для выставления.
        *   Если заполнено: Работа уже включена в УПД с соответствующим `id`. Она считается "реализованной".

*   #### `upd_documents` (Документы УПД)
    *   **Назначение:** Хранит "шапку" каждого счета (УПД).
    *   **Ключевые поля:** `id`, `document_number`, `document_date`, `status`, `counterparty_id`.

### 2.2. Справочники
*   `counterparties`: Список ваших клиентов.
*   `subdivisions`: Список подразделений, привязанных к клиентам.
*   `motors`: Справочник типов двигателей.

---

## 3. Ключевые бизнес-процессы и взаимодействие с таблицами

### 3.1. Процесс "Приемка"

Этот процесс активируется, когда пользователь загружает Excel-файл с данными о новых двигателях и нажимает "Сохранить".

**Цель:** Зарегистрировать в системе новые объекты для ремонта и список необходимых работ.

**Пошаговая логика:**

1.  **Создание Приемки (1 запись):**
    *   На основе данных из файла создается **одна** запись в таблице `receptions`.

2.  **Создание Двигателей (N записей):**
    *   Система группирует строки файла по "Номеру позиции" для создания уникальных двигателей.
    *   Для каждой группы создается **одна** запись в `accepted_motors`, которая связывается с `id` приемки из шага 1. На этом шаге генерируется `id` для будущего QR-кода.

3.  **Создание Позиций Работ (M записей):**
    *   Система проходит по **каждой строке** Excel-файла.
    *   Для каждой строки создается **одна** запись в `reception_items`.
    *   Каждая запись связывается с `id` соответствующего двигателя из шага 2.
    *   **Важнейший результат:** Для всех созданных записей в `reception_items` поле `upd_document_id` устанавливается в `NULL`.

  <!-- Замените на реальную ссылку на диаграмму, если есть -->
`[Excel-файл] -> [Сохранение] -> 1. INSERT в receptions -> 2. INSERT в accepted_motors -> 3. INSERT в reception_items (с upd_document_id = NULL)`

### 3.2. Процесс "Создать УПД"

Этот процесс активируется, когда пользователь на странице "Создать УПД" нажимает "Создать новый УПД", выбирает работы и сохраняет документ.

**Цель:** Выставить счет за выбранные работы и отметить их как "реализованные".

**Пошаговая логика:**

1.  **Отображение доступных работ (Frontend):**
    *   Приложение делает запрос к `reception_items`, чтобы получить все записи, у которых `upd_document_id IS NULL` и которые принадлежат выбранному контрагенту.
    *   Пользователь видит список "свободных" работ и отмечает нужные чекбоксами.

2.  **Сохранение УПД (Backend, транзакция):**
    *   **Шаг А: Создание документа.** Приложение выполняет `INSERT` в таблицу `upd_documents` и немедленно получает `id` нового документа (`new_upd_id`).
    *   **Шаг Б: Привязка работ.** Приложение выполняет `UPDATE` для таблицы `reception_items`. Оно устанавливает `SET upd_document_id = new_upd_id` для всех позиций, которые пользователь выбрал чекбоксами.

**Результат:** Выбранные работы теперь "привязаны" к конкретному УПД. При следующем запросе доступных работ они больше не появятся в списке, так как их `upd_document_id` больше не `NULL`.

 <!-- Замените на реальную ссылку на диаграмму, если есть -->
`[Выбор работ с NULL] -> [Сохранить УПД] -> 1. INSERT в upd_documents -> 2. UPDATE в reception_items (установить upd_document_id)`

---

# Схема Базы Данных (Supabase/PostgreSQL)

Данный документ описывает структуру базы данных для системы управления ремонтом электродвигателей. Все таблицы используют Row Level Security (RLS) и привязаны к `auth.users` через `user_id`.

## 4. Справочники и Основные Сущности

Эти таблицы служат для хранения базовых данных, необходимых для работы системы.

### `counterparties` (Контрагенты)
Хранит информацию о клиентах, поставщиках и партнерах.

| Поле | Тип | Описание | Примечания |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Первичный ключ | |
| `user_id` | `uuid` | Владелец записи | FK: `auth.users` |
| `name` | `text` | Название контрагента | UNIQUE INDEX |
| `code` | `text` | Внутренний код | |
| `contact_info` | `text` | Общая контактная информация | |
| `inn` | `text` | ИНН | UNIQUE INDEX (WHERE NOT NULL) |
| `kpp` | `text` | КПП | |
| `address` | `text` | Юридический адрес | |
| `contact_person` | `text` | Контактное лицо | |
| `phone` | `text` | Телефон | |
| `email` | `text` | Электронная почта | |
| `description` | `text` | Дополнительное описание | |
| `is_active` | `boolean` | Статус активности | DEFAULT `true` |
| `created_at` | `timestamptz` | Дата создания | |
| `updated_at` | `timestamptz` | Дата последнего обновления | Обновляется триггером |

### `subdivisions` (Подразделения)
Хранит информацию о внутренних подразделениях, цехах или локациях.

| Поле | Тип | Описание | Примечания |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Первичный ключ | |
| `user_id` | `uuid` | Владелец записи | FK: `auth.users` |
| `name` | `text` | Название подразделения | NOT NULL |
| `code` | `text` | Код подразделения | |
| `description` | `text` | Описание | |
| `created_at` | `timestamptz` | Дата создания | |

### `motors` (Двигатели)
Справочник моделей электродвигателей и их характеристик.

| Поле | Тип | Описание | Примечания |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Первичный ключ | |
| `user_id` | `uuid` | Владелец записи | FK: `auth.users` |
| `name` | `text` | Наименование модели | NOT NULL |
| `power_kw` | `numeric(8, 2)` | Мощность (кВт) | NOT NULL, DEFAULT 0 |
| `rpm` | `integer` | Обороты в минуту | NOT NULL, DEFAULT 0 |
| `voltage` | `integer` | Напряжение (В) | DEFAULT 380 |
| `current` | `numeric(8, 2)` | Ток (А) | DEFAULT 0 |
| `efficiency` | `numeric(5, 2)` | КПД (%) | DEFAULT 0 |
| `manufacturer` | `text` | Производитель | |
| `price_per_unit` | `numeric(12, 2)` | Цена за единицу | NOT NULL, DEFAULT 0 |
| `is_active` | `boolean` | Статус активности | DEFAULT `true` |
| `text` | `text` | Дополнительный текст/описание | |
| `created_at` | `timestamptz` | Дата создания | |
| `updated_at` | `timestamptz` | Дата последнего обновления | Обновляется триггером |

## 5. Приемка и Ремонт (Модуль Приемки)

Этот модуль управляет процессом регистрации двигателей, принятых в ремонт.

### `receptions` (Документы Приемки)
Заголовок документа, связывающий приемку с контрагентом.

| Поле | Тип | Описание | Связи |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Первичный ключ | |
| `reception_date` | `timestamptz` | Дата приемки | |
| `reception_number` | `text` | Номер документа | |
| `counterparty_id` | `uuid` | Контрагент | FK: `counterparties` (ON DELETE RESTRICT) |
| `user_id` | `uuid` | Владелец записи | FK: `auth.users` |

### `accepted_motors` (Принятые Двигатели)
Индивидуальный двигатель, принятый в рамках документа `receptions`. ID этой записи используется для генерации QR-кода.

| Поле | Тип | Описание | Связи |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Первичный ключ (QR Code ID) | |
| `reception_id` | `uuid` | Ссылка на документ приемки | FK: `receptions` (ON DELETE CASCADE) |
| `subdivision_id` | `uuid` | Подразделение, куда принят двигатель | FK: `subdivisions` (ON DELETE SET NULL) |
| `position_in_reception` | `int` | Позиция в документе приемки | NOT NULL |
| `motor_service_description` | `text` | Описание требуемого сервиса | NOT NULL |
| `user_id` | `uuid` | Владелец записи | FK: `auth.users` |

### `reception_items` (Позиции Приемки)
Детализация работ, необходимых для конкретного принятого двигателя. Эти позиции позже связываются с финансовым документом (UPD).

| Поле | Тип | Описание | Связи |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Первичный ключ | |
| `accepted_motor_id` | `uuid` | Ссылка на принятый двигатель | FK: `accepted_motors` (ON DELETE CASCADE) |
| `item_description` | `text` | Описание работы/услуги | NOT NULL |
| `work_group` | `text` | Группа работ | |
| `quantity` | `numeric` | Количество | DEFAULT 1 |
| `price` | `numeric` | Цена за единицу | DEFAULT 0 |
| `upd_document_id` | `uuid` | Ссылка на сформированный УПД | FK: `upd_documents` (NULLABLE) |
| `user_id` | `uuid` | Владелец записи | FK: `auth.users` |

## 6. Финансовые Документы (Модуль УПД)

Этот модуль управляет формированием Универсальных Передаточных Документов (УПД).

### `upd_documents` (Заголовки УПД)
Заголовок финансового документа.

| Поле | Тип | Описание | Связи |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Первичный ключ | |
| `user_id` | `uuid` | Владелец записи | FK: `auth.users` |
| `document_number` | `text` | Номер документа | |
| `counterparty_id` | `uuid` | Контрагент | FK: `counterparties` (ON DELETE RESTRICT) |
| `document_date` | `timestamptz` | Дата документа | |
| `total_income` | `numeric` | Общая сумма дохода | DEFAULT 0 |
| `total_expense` | `numeric` | Общая сумма расхода | DEFAULT 0 |
| `status` | `text` | Статус документа | DEFAULT 'Draft' |
| `subdivision_id` | `uuid` | Подразделение, формирующее документ | FK: `subdivisions` (ON DELETE RESTRICT) |

### `upd_document_items` (Позиции УПД)
Иерархические позиции внутри УПД.

| Поле | Тип | Описание | Связи |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Первичный ключ | |
| `document_id` | `uuid` | Ссылка на заголовок УПД | FK: `upd_documents` (ON DELETE CASCADE) |
| `parent_id` | `uuid` | Ссылка на родительскую позицию | Self-referencing (ON DELETE CASCADE) |
| `level` | `integer` | Уровень иерархии (1: Position, 2: Subgroup, 3: Line) | NOT NULL |
| `order_index` | `integer` | Порядок сортировки | |
| `item_type` | `text` | Тип элемента (Position, Subgroup, Line) | NOT NULL |
| `description` | `text` | Описание позиции | NOT NULL |
| `quantity` | `numeric` | Количество | DEFAULT 1 |
| `price` | `numeric` | Цена за единицу | DEFAULT 0 |
| `is_income` | `boolean` | Доход/Расход | DEFAULT `true` |
| `motor_id` | `uuid` | Ссылка на модель двигателя (если применимо) | FK: `motors` (ON DELETE SET NULL) |
| `original_order_id` | `uuid` | Ссылка на старую таблицу `repair_orders` (DEPRECATED) | FK: `repair_orders` (ON DELETE SET NULL) |

## 7. Хранимые Процедуры (RPC)

### `create_upd_and_link_reception_items`

Эта функция обеспечивает атомарное создание нового документа УПД и связывание с ним выбранных позиций из приемки (`reception_items`).

**Назначение:** Транзакционное формирование финансового документа из списка принятых работ.

**Сигнатура:**
```sql
create_upd_and_link_reception_items(
    p_counterparty_id uuid,
    p_subdivision_id uuid,
    p_document_number text,
    p_document_date text,
    p_item_ids uuid[] -- Массив ID из reception_items
) RETURNS uuid
```

**Логика:**
1. Проверяет аутентификацию пользователя (`auth.uid()`).
2. Вставляет новую запись в `upd_documents`.
3. Обновляет все записи в `reception_items`, чьи ID содержатся в `p_item_ids`, устанавливая им `upd_document_id` на ID нового УПД.
4. Возвращает ID созданного документа УПД.

## 8. Безопасность (Row Level Security)

RLS включен на всех таблицах. Политики настроены таким образом, что аутентифицированный пользователь может выполнять CRUD операции только над теми записями, где `user_id` совпадает с его собственным ID (`auth.uid()`).

Для `upd_document_items` используется вспомогательная функция `check_document_owner` для проверки владения родительским документом (`upd_documents`).
